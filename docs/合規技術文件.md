# 合規技術文件

**文件編號**：COMP-001  
**版本**：1.1  
**生效日期**：2026-02-05  
**適用系統**：智慧股票投資決策支援系統（MMBP 後端 API + FMFA 前端平台）  
**文件性質**：技術合規／法遵參考文件

---

## 一、文件目的與範圍

### 1.1 目的

本合規技術文件旨在從**技術實作面**說明智慧股票投資決策支援系統之架構、資料處理、稽核追蹤、模型風險管理及安全控管措施，供內部稽核、法遵、風控及主管機關查核時參考，確保系統設計符合法規與內部政策要求。

### 1.2 適用範圍

| 項目 | 說明 |
|------|------|
| **系統範圍** | MMBP（後端決策引擎）+ FMFA（前端分析平台） |
| **技術面向** | 資料流、稽核日誌、模型版本、資安措施、個人資料處理 |
| **法規參照** | 個人資料保護法、證券投資相關法規、金融科技法遵實務 |

### 1.3 相關文件

| 文件 | 編號 | 說明 |
|------|------|------|
| 隱私權政策 | — | 使用者資料蒐集、使用與保護 |
| SLA 與可用性說明 | SLA-001 | 服務等級與責任上限 |
| POC 概念驗證文件 | POC-001 | 概念驗證範圍與成功準則 |
| DLC 可下載內容說明 | DLC-001 | 可下載內容與使用條款 |
| 模型版本說明 | MODEL_VERSION.md | 模型／策略版本與變更日誌 |

---

## 二、系統架構概觀

### 2.1 整體架構圖

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           使用者（瀏覽器）                                 │
└─────────────────────────────────────┬───────────────────────────────────┘
                                      │ HTTPS
                                      ▼
┌─────────────────────────────────────────────────────────────────────────┐
│  FMFA 前端平台（React + TypeScript + Vite）                               │
│  - K 線、KD、MACD、成交量圖表                                             │
│  - 股票搜尋、投資建議展示、LLM 對話介面                                    │
│  - 隱私權政策、服務條款、系統說明頁面                                      │
└─────────────────────────────────────┬───────────────────────────────────┘
                                      │ REST API / SSE
                                      ▼
┌─────────────────────────────────────────────────────────────────────────┐
│  MMBP 後端服務（FastAPI）                                                 │
│  - 審計中介層（AuditMiddleware）                                          │
│  - 股價／指標／預測／回測 API                                             │
│  - LLM 串流、審計日誌                                                     │
└─────────────────────────────────────┬───────────────────────────────────┘
                                      │
         ┌────────────────────────────┼────────────────────────────┐
         ▼                            ▼                            ▼
   [Yahoo Finance]              [ML Model]                   [Ollama/LLM]
   金融資料來源                  推論引擎                       對話服務
```

### 2.2 技術棧

| 層級 | 技術 | 版本／備註 |
|------|------|------------|
| **前端** | React | 18+ |
| | TypeScript | — |
| | Vite | 建置工具 |
| **後端** | Python | ≥ 3.10 |
| | FastAPI | ≥ 0.128.0 |
| | scikit-learn | ≥ 1.7.2 |
| | yfinance | 金融資料 |
| **傳輸** | REST API | JSON |
| | SSE | LLM 串流 |

---

## 三、串接架構與整合規範

### 3.1 前端與後端串接（FMFA ↔ MMBP）

#### 3.1.1 連線設定

| 項目 | 說明 |
|------|------|
| **API Base URL** | 由前端環境變數 `VITE_API_BASE_URL` 指定，例如 `http://localhost:8000` 或正式環境網域 |
| **API 前綴** | 統一使用 `/api/v1` |
| **內容類型** | 請求 `Content-Type: application/json`；回應為 JSON 或 `text/event-stream`（SSE） |

#### 3.1.2 股票代碼正規化

前端在呼叫 API 前會對股票代碼進行正規化（`normalizeTaiwanSymbol`）：

- 若已有市場後綴（如 `2330.TW`），則保留。
- 若為純數字（如 `2330`），自動補上 `.TW`（台股預設）。
- 確保後端接收之 symbol 格式一致，避免 yfinance 查詢錯誤。

#### 3.1.3 前端 API 呼叫層

| 前端函式 | 後端 API | 方法 | 說明 |
|----------|----------|------|------|
| `fetchStockData` | `GET /api/v1/stock/{symbol}/data` | GET | 原始股價資料 |
| `fetchStockIndicators` | `GET /api/v1/stock/{symbol}/indicators` | GET | 含技術指標之股價資料 |
| `fetchPrediction` | `POST /api/v1/predict` | POST | 預測與投資建議 |
| `fetchBacktest` | `GET /api/v1/backtest` | GET | 單資產回測 |
| — | `POST /api/v1/chat/stream` | POST | LLM 串流對話（fetch + ReadableStream） |

所有 REST 呼叫透過 `apiRequest` 統一處理錯誤與 JSON 解析；支援 `AbortSignal` 以取消進行中之請求。

### 3.2 REST API 串接規格

#### 3.2.1 共通 Headers

| Header | 說明 | 備註 |
|--------|------|------|
| `Content-Type` | `application/json` | POST 請求必填 |
| `X-Client-Id` | 客戶端識別碼 | 可選，寫入審計日誌 |
| `X-Api-Key` | API 金鑰 | 可選，若啟用認證；審計時以 HMAC 雜湊，不存明文 |

#### 3.2.2 端點與資料格式對照

| 端點 | 請求 | 回應 | 審計 |
|------|------|------|------|
| `GET /api/v1/health` | — | `{ "status": "ok" }` | 否 |
| `GET /api/v1/model-info` | — | `model_version`, `strategy_version`, `model_effective_date` 等 | 否 |
| `GET /api/v1/stock/{symbol}/data?period=10y` | query: `period` | `{ symbol, period, rows, data[] }` | 是 |
| `GET /api/v1/stock/{symbol}/indicators?period=10y` | query: `period` | `{ symbol, period, rows, data[] }` | 是 |
| `POST /api/v1/predict` | body: `{ symbol, period? }` | `{ symbol, probabilities, system_score, recommendation, model_version, ... }` | 是 |
| `GET /api/v1/backtest?symbol=...&start=...&end=...` | query: symbol, start, end 等 | `{ symbol, equity_curve, annualized_return, model_version, ... }` | 是 |
| `POST /api/v1/backtest/portfolio` | body: `{ symbols[], start?, end?, ... }` | 同上（symbol 為 `"PORTFOLIO"`） | 是 |
| `POST /api/v1/chat/stream` | body: `{ symbol, message, context? }` | SSE 串流 | 否（未納入審計） |

#### 3.2.3 錯誤回應格式

- HTTP 狀態碼：`400`（參數錯誤）、`404`（資源不存在）、`500`（伺服器錯誤）。
- 本文格式：`{ "detail": "錯誤訊息字串或詳情物件" }`。
- 前端依 `detail` 顯示使用者可理解之訊息。

### 3.3 SSE 串流串接（LLM 對話）

#### 3.3.1 連線方式

| 項目 | 說明 |
|------|------|
| **端點** | `POST /api/v1/chat/stream` |
| **Media Type** | `text/event-stream` |
| **前端實作** | 使用 `fetch` + `response.body.getReader()` 與 `TextDecoder` 解析 SSE 區塊 |

#### 3.3.2 SSE 事件格式

| 事件 | 說明 |
|------|------|
| `data:` | 文字內容區塊，可多行 |
| `event: done` | 串流結束 |
| `event: error` | 後端錯誤，`data` 為錯誤訊息 |

#### 3.3.3 前端處理流程

1. 發送 POST，body 為 `{ symbol, message, context }`。
2. 檢查 `resp.ok` 與 `resp.body`。
3. 以 `reader.read()` 逐區塊讀取。
4. 以 `\n\n` 切割 SSE 區塊，解析 `event:` 與 `data:`。
5. 遇 `event: done` 或 `event: error` 即結束，否則將 `data` 累加至 AI 訊息。

#### 3.3.4 合規注意事項

- LLM 串流 API **目前未納入審計**，若需追蹤對話紀錄，可於後續版本納入審計範圍。
- 前端傳送之 `context` 可能包含技術指標摘要，屬一般分析資料，非個人可識別資訊。

### 3.4 外部服務串接

| 服務 | 用途 | 連線方式 | 合規考量 |
|------|------|----------|----------|
| **Yahoo Finance（yfinance）** | 歷史股價與成交量 | HTTP 下載，Python 同步呼叫 | 公開市場資料；其可用性與正確性不在本 SLA 保證範圍 |
| **Ollama** | LLM 推論（投資助理對話） | HTTP POST 至 `localhost:11434` 或遠端端點 | 若為本機佈署，無外連；遠端時需確保 TLS 與存取控制 |
| **n8n（選用）** | 工作流自動化（如新聞摘要、推播） | 獨立流程，可呼叫 Ollama 等 | 與主系統分離；若串接 MMBP API，應納入審計與權限控管 |

### 3.5 串接合規檢核

| 檢核項目 | 狀態 | 備註 |
|----------|------|------|
| API 前綴統一（`/api/v1`） | ✓ | 路由層與前端一致 |
| 股票代碼正規化 | ✓ | 前端 `normalizeTaiwanSymbol` |
| 請求取消支援（AbortSignal） | ✓ | 前端可取消長時間請求 |
| 錯誤格式統一（`detail`） | ✓ | 前後端約定 |
| CORS 設定 | 建議 | 生產環境應限制允許來源 |
| 逾時設定 | 建議 | 前端／反向代理可設 timeout |

### 3.6 整合測試建議

- **健康檢查**：`GET /api/v1/health` 驗證後端存活。
- **端對端**：前端選股 → 呼叫指標／預測／回測 → 驗證圖表與建議顯示。
- **SSE**：發送 chat 請求 → 驗證串流逐字顯示與 `event: done` 結束。
- **錯誤情境**：無效 symbol、網路中斷、500 錯誤 → 驗證前端錯誤提示。

---

## 四、資料處理與個人資料保護

### 4.1 資料分類

| 資料類型 | 說明 | 敏感性 | 處理原則 |
|----------|------|--------|----------|
| **查詢參數** | 股票代碼、期間、篩選條件 | 低 | 審計摘要記錄，不存完整資料 |
| **使用紀錄** | IP、存取時間、Client-Id、API Key 雜湊 | 中 | 審計日誌，有保留期限 |
| **金融資料** | 股價、指標、預測結果 | 低（公開資料） | 即時計算，不長期儲存原始檔 |
| **對話內容** | LLM 對話訊息 | 依內容而定 | 由前端傳送，後端串流回應，不持久化對話紀錄 |

### 4.2 個人資料蒐集與使用（依隱私權政策）

本系統蒐集之資料類型與目的對應如下：

| 蒐集項目 | 蒐集方式 | 使用目的 | 法源依據 |
|----------|----------|----------|----------|
| 查詢時輸入之股票代碼、區間 | 使用者操作 | 提供分析服務 | 契約履行 |
| IP、存取時間、瀏覽器／裝置資訊 | 伺服器日誌、審計 | 安全防護、異常偵測、統計 | 正當利益 |
| Cookie、本地儲存 | 瀏覽器技術 | 作業階段、偏好、匿名統計 | 同意或正當利益 |

### 4.3 資料保存與刪除

| 項目 | 保存期限 | 刪除機制 |
|------|----------|----------|
| **審計日誌** | 預設 180 天（可設定） | 服務啟動時自動刪除逾保留天數之檔案 |
| **金融資料** | 不持久化 | 每次由外部來源即時抓取，不另儲存 |
| **預測／回測結果** | 不持久化 | API 即時計算回傳，不寫入資料庫 |

### 4.4 傳輸與儲存安全

- **傳輸**：建議生產環境使用 HTTPS，避免明文傳輸敏感資料。
- **審計檔**：新建立之審計檔權限為 `0600`（僅 owner 可讀寫），建議僅部署主機上之稽核／維運帳號可存取審計目錄。
- **API Key**：若使用 `X-Api-Key`，系統以 HMAC-SHA256 雜湊後存入審計日誌，**不儲存明文**。

---

## 五、稽核與追蹤機制

### 5.1 審計範圍

以下 API 路徑納入審計日誌記錄：

| API 路徑 | 方法 | 說明 |
|----------|------|------|
| `/api/v1/predict` | POST | 預測與投資建議 |
| `/api/v1/backtest` | GET | 單資產回測 |
| `/api/v1/backtest/portfolio` | POST | 組合回測 |
| `/api/v1/stock/{symbol}/indicators` | GET | 含指標之股價資料 |
| `/api/v1/stock/{symbol}/data` | GET | 原始股價資料 |

### 5.2 審計日誌欄位

每筆審計紀錄包含（符合「誰、何時、何標的、何操作、何結果」之合規需求）：

| 欄位 | 說明 |
|------|------|
| `ts` | 時間（UTC ISO8601） |
| `request_id` | 唯一請求識別碼 |
| `client_ip` | 來源 IP（含 X-Forwarded-For 支援） |
| `client_id` | X-Client-Id 標頭（若有） |
| `api_key_hash` | X-Api-Key 之 HMAC 雜湊（若有，不存明文） |
| `method`, `path` | HTTP 方法與路徑 |
| `query_summary` | 查詢參數摘要 |
| `body_summary` | 請求本文摘要（symbol、symbols、區間等） |
| `symbol` / `symbols` | 查詢標的 |
| `status_code` | HTTP 狀態碼 |
| `latency_ms` | 回應延遲（毫秒） |
| `result_summary` | 回應摘要（如 recommendation、annualized_return、rows 等，**不存完整資料**） |
| `error_type`, `error_message` | 錯誤類型與訊息（失敗時） |

### 5.3 審計日誌格式與存放

- **格式**：JSONL（每行一筆 JSON）
- **檔名**：`audit-YYYY-MM-DD.jsonl`（每日一檔）
- **目錄**：由環境變數 `AUDIT_LOG_DIR` 指定，預設 `logs/audit`
- **保留天數**：由 `AUDIT_RETENTION_DAYS` 指定，預設 180 天

### 5.4 審計檔存取控制建議

- 審計目錄應限制僅授權之稽核／維運人員可讀取。
- 定期備份審計檔至安全儲存，以利事後稽核與爭議調查。
- 審計寫入失敗不影響 API 回應，以確保服務可用性，但應監控告警。

---

## 六、模型風險管理與版本控制

### 6.1 版本資訊來源

- **程式內單一來源**：`config/versioning.py`
- **環境變數覆寫**：`MODEL_VERSION`、`STRATEGY_VERSION`、`MODEL_EFFECTIVE_DATE`

### 6.2 版本揭露

| 項目 | 說明 |
|------|------|
| **model_version** | 模型版本號 |
| **strategy_version** | 策略／評分邏輯版本號 |
| **model_effective_date** | 模型上線日期（YYYY-MM-DD） |

上述版本資訊於下列 API 回應中一併回傳，供稽核與前端顯示：

- `POST /api/v1/predict`
- `GET /api/v1/backtest`
- `POST /api/v1/backtest/portfolio`

另可透過 `GET /api/v1/model-info` 查詢目前使用之模型／策略版本、訓練區間與主要假設。

### 6.3 模型與策略假設（摘要）

- **模型**：Random Forest，三類標籤（不建議持有／長期持有／觀望）。
- **評分邏輯**：系統權重—模型機率 0.50、基本面 0.25、技術面 0.25；門檻 THRESH_BUY=0.60、THRESH_HOLD=0.50。
- **回測**：訊號由模型＋基本面門檻產生；倉位為 2 ATR 移動停損；可選波動率目標倉位；手續費 0.15%。

完整說明見 [MODEL_VERSION.md](../MODEL_VERSION.md)。

---

## 七、安全控管措施

### 7.1 已實作措施

| 措施 | 說明 |
|------|------|
| **審計中介層** | 關鍵 API 呼叫均經 AuditMiddleware 記錄 |
| **API Key 雜湊** | 若有使用 X-Api-Key，以 HMAC-SHA256 雜湊，不存明文 |
| **審計檔權限** | 新檔 `chmod 0600`，僅 owner 可讀寫 |
| **審計保留與清理** | 逾保留天數自動刪除，避免無限期累積 |
| **結果摘要** | 審計僅存摘要，不存完整股價／指標陣列 |

### 7.2 建議強化措施（依部署環境）

| 措施 | 說明 |
|------|------|
| **HTTPS** | 生產環境強制使用 TLS 加密傳輸 |
| **API 認證** | 視需求啟用 API Key、JWT 或 OAuth |
| **CORS** | 限制允許之來源網域，避免未授權前端呼叫 |
| **速率限制** | 防範濫用與 DDoS |
| **秘密管理** | 環境變數、金鑰庫（如 HashiCorp Vault）管理敏感設定 |

### 7.3 敏感設定與環境變數

以下環境變數可能涉及敏感資訊，應妥善管理：

| 變數 | 說明 | 建議 |
|------|------|------|
| `AUDIT_HMAC_SECRET` | API Key 雜湊用密鑰 | 強密碼、定期輪換、不提交版控 |
| `MODEL_PATH` | 模型檔路徑 | 部署時指定，權限限制 |
| `VITE_API_BASE_URL` | 前端 API 基底 URL | 依環境設定，生產勿用明文測試 URL |

---

## 八、風險揭露與免責

### 8.1 投資建議免責

本系統提供之預測、評分與回測結果**僅供研究與決策輔助**，不構成投資建議。投資風險由使用者自負，過往績效不代表未來表現。

### 8.2 外部服務依賴

- **金融資料**：依賴 Yahoo Finance（yfinance）等第三方，其可用性與正確性不在本 SLA 保證範圍。
- **LLM 服務**：若使用 Ollama 或其他 LLM，其回應內容與可用性由該服務提供方負責。

### 8.3 責任上限

依 [SLA-001 服務等級協議](SLA與可用性說明.md)，責任上限與免責範圍以該文件及正式合約為準。

---

## 九、合規檢核表（供稽核使用）

### 9.1 資料保護

| 檢核項目 | 狀態 | 備註 |
|----------|------|------|
| 個人資料蒐集有明確目的 | ✓ | 見隱私權政策 |
| 審計日誌不存完整敏感資料 | ✓ | 僅存摘要 |
| API Key 不以明文儲存 | ✓ | HMAC 雜湊 |
| 審計檔有保留期限與清理 | ✓ | 預設 180 天 |

### 9.2 稽核追蹤

| 檢核項目 | 狀態 | 備註 |
|----------|------|------|
| 關鍵 API 有審計記錄 | ✓ | predict、backtest、stock/* |
| 可識別來源（IP、Client-Id） | ✓ | 審計欄位含 client_ip、client_id |
| 可追溯請求與結果 | ✓ | request_id、result_summary |
| 審計檔存取受限 | 建議 | 依部署設定 |

### 9.3 模型風險管理

| 檢核項目 | 狀態 | 備註 |
|----------|------|------|
| 模型版本可查詢 | ✓ | GET /api/v1/model-info |
| 預測／回測回應含版本資訊 | ✓ | model_version、strategy_version、model_effective_date |
| 版本與假設有文件記錄 | ✓ | MODEL_VERSION.md |

### 9.4 安全

| 檢核項目 | 狀態 | 備註 |
|----------|------|------|
| 傳輸加密（HTTPS） | 建議 | 依部署環境 |
| 審計檔權限限制 | ✓ | 0600 |
| 敏感設定不由版控提交 | 建議 | .env 於 .gitignore |

---

## 十、文件修訂紀錄

| 版本 | 日期 | 修訂內容 | 修訂者 |
|------|------|----------|--------|
| 1.0 | 2026-02-05 | 初版發布 | — |
| 1.1 | 2026-02-05 | 新增第三章「串接架構與整合規範」，涵蓋前後端串接、REST/SSE 規格、外部服務與整合測試建議 | — |

---

## 十一、聯絡與審閱

| 項目 | 說明 |
|------|------|
| **文件維護** | 技術／法遵團隊 |
| **審閱週期** | 每半年或於系統架構／法規重大變更時 |
| **相關窗口** | 見首頁或系統說明頁之聯絡管道 |

---

*本文件為技術合規參考文件，具體法遵義務以主管機關要求及正式合約為準。*
