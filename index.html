<!-- <!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>玩股網風格 K 線</title>
  <script src="https://cdn.plot.ly/plotly-2.30.0.min.js"></script>
  <style>
    body {
      background: #111;
      color: #eee;
      font-family: Consolas, monospace;
    }
    #title {
      white-space: pre-line;
      margin: 10px;
      font-size: 14px;
    }
  </style>
</head>
<body>

<div id="title"></div>
<div id="chart"></div>

<script>
const ticker = "AAPL";

/* =========================
   工具函式
========================= */
const SMA = (arr, n) =>
  arr.map((v, i) =>
    i < n - 1 ? null :
    arr.slice(i - n + 1, i + 1).reduce((a,b)=>a+b,0) / n
  );

const EMA = (arr, n) => {
  const k = 2 / (n + 1);
  let ema = [arr[0]];
  for (let i = 1; i < arr.length; i++) {
    ema.push(arr[i] * k + ema[i-1] * (1 - k));
  }
  return ema;
};

const arrow = arr =>
  arr[arr.length-1] >= arr[arr.length-2] ? "↑" : "↓";

/* =========================
   抓 Yahoo Finance
========================= */
/* fetch(`https://query1.finance.yahoo.com/v8/finance/chart/${ticker}?interval=1d&range=1y`) */
fetch(
  "https://corsproxy.io/?" +
  encodeURIComponent("https://query1.finance.yahoo.com/v8/finance/chart/AAPL?interval=1d&range=1y")
)

.then(r => r.json())
.then(json => {
  const r = json.chart.result[0];
  const t = r.timestamp.map(x => new Date(x * 1000));

  const O = r.indicators.quote[0].open;
  const H = r.indicators.quote[0].high;
  const L = r.indicators.quote[0].low;
  const C = r.indicators.quote[0].close;
  const V = r.indicators.quote[0].volume;

  /* =========================
     指標計算
  ========================= */
  const maList = [5,10,20,60,120,240];
  const MAs = Object.fromEntries(maList.map(m => [m, SMA(C, m)]));

  const MV5 = SMA(V, 5);
  const MV20 = SMA(V, 20);

  const low9 = SMA(L, 9);
  const high9 = SMA(H, 9);
  const K = C.map((c,i)=> ((c-low9[i])/(high9[i]-low9[i]))*100 );
  const D = SMA(K, 3);

  const ema12 = EMA(C,12);
  const ema26 = EMA(C,26);
  const DIF = ema12.map((v,i)=>v-ema26[i]);
  const DEA = EMA(DIF,9);
  const MACD = DIF.map((v,i)=>2*(v-DEA[i]));

  /* =========================
     玩股網文字
  ========================= */
  const maText = maList.map(
    m => `MA${m} ${MAs[m].at(-1).toFixed(2)} ${arrow(MAs[m])}`
  ).join("   ");

  const volText =
    `MV5 ${MV5.at(-1).toFixed(1)} ${arrow(MV5)}   ` +
    `MV20 ${MV20.at(-1).toFixed(1)} ${arrow(MV20)}   ` +
    `量 ${V.at(-1).toLocaleString()} ${arrow(V)}`;

  const kdText =
    `K9 ${K.at(-1).toFixed(2)} ${arrow(K)}   ` +
    `D9 ${D.at(-1).toFixed(2)} ${arrow(D)}`;

  document.getElementById("title").innerText =
    `${ticker}\n${maText}\n${volText}\n${kdText}`;

  /* =========================
     Plotly 圖表
  ========================= */
  const traces = [

    // K 線
    {
      type: "candlestick",
      x: t, open: O, high: H, low: L, close: C,
      increasing: {line: {color: "red"}},
      decreasing: {line: {color: "green"}},
      xaxis: "x", yaxis: "y"
    },

    // 均線
    ...maList.map((m,i)=>({
      x: t, y: MAs[m],
      type: "scatter", mode: "lines",
      name: `MA${m}`,
      line: {width:1}
    })),

    // 成交量
    {
      x: t, y: V, type: "bar",
      yaxis: "y2",
      marker: {color: V.map((v,i)=>C[i]>=O[i]?"red":"green")},
      name: "Volume"
    },

    // KD
    {x:t,y:K,yaxis:"y3",type:"scatter",name:"K"},
    {x:t,y:D,yaxis:"y3",type:"scatter",name:"D"},
    {x:t,y:Array(t.length).fill(80),yaxis:"y3",line:{dash:"dot"},showlegend:false},
    {x:t,y:Array(t.length).fill(20),yaxis:"y3",line:{dash:"dot"},showlegend:false},

    // MACD
    {
      x:t,y:MACD,yaxis:"y4",type:"bar",
      marker:{color:MACD.map(v=>v>=0?"red":"green")},
      name:"MACD"
    },
    {x:t,y:DIF,yaxis:"y4",type:"scatter",name:"DIF"},
    {x:t,y:DEA,yaxis:"y4",type:"scatter",name:"DEA"}
  ];

  const layout = {
    paper_bgcolor:"#111",
    plot_bgcolor:"#111",
    font:{color:"#eee"},
    height:900,
    grid:{rows:4,columns:1,pattern:"independent"},
    xaxis:{rangeslider:{visible:false}},
    yaxis:{title:"Price"},
    yaxis2:{title:"Volume"},
    yaxis3:{title:"KD"},
    yaxis4:{title:"MACD"}
  };

  Plotly.newPlot("chart", traces, layout);
});
</script>
</body>
</html> -->




<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>玩股網風格 K 線</title>
  <script src="https://cdn.plot.ly/plotly-2.30.0.min.js"></script>
  <style>
    body {
      background: #111;
      color: #eee;
      font-family: Consolas, monospace;
    }
    #title {
      white-space: pre-line;
      margin: 10px;
      font-size: 14px;
    }
    .chart {
      height: 300px;
      margin-bottom: 20px;
    }
  </style>
</head>
<body>

<div id="title"></div>

<div id="kline" class="chart"></div>
<div id="volume" class="chart"></div>
<div id="kd" class="chart"></div>
<div id="macd" class="chart"></div>

<script>
const ticker = "AAPL";

/* =========================
   工具函式
========================= */
const SMA = (arr, n) =>
  arr.map((v, i) =>
    i < n - 1 ? null :
    arr.slice(i - n + 1, i + 1).reduce((a,b)=>a+b,0) / n
  );

const EMA = (arr, n) => {
  const k = 2 / (n + 1);
  let ema = [arr[0]];
  for (let i = 1; i < arr.length; i++) {
    ema.push(arr[i] * k + ema[i-1] * (1 - k));
  }
  return ema;
};

const arrow = arr =>
  arr[arr.length-1] >= arr[arr.length-2] ? "↑" : "↓";

/* =========================
   抓 Yahoo Finance（純前端）
========================= */
fetch(
  "https://corsproxy.io/?" +
  encodeURIComponent(
    `https://query1.finance.yahoo.com/v8/finance/chart/${ticker}?interval=1d&range=1y`
  )
)
.then(r => r.json())
.then(json => {

  const r = json.chart.result[0];
  const t = r.timestamp.map(x => new Date(x * 1000));
  const q = r.indicators.quote[0];

  const O = q.open;
  const H = q.high;
  const L = q.low;
  const C = q.close;
  const V = q.volume;

  /* =========================
     指標計算
  ========================= */
  const maList = [5,10,20,60,120,240];
  const MAs = Object.fromEntries(maList.map(m => [m, SMA(C, m)]));

  const MV5 = SMA(V, 5);
  const MV20 = SMA(V, 20);

  const low9 = SMA(L, 9);
  const high9 = SMA(H, 9);
  const K = C.map((c,i)=> ((c-low9[i])/(high9[i]-low9[i]))*100 );
  const D = SMA(K, 3);

  const ema12 = EMA(C,12);
  const ema26 = EMA(C,26);
  const DIF = ema12.map((v,i)=>v-ema26[i]);
  const DEA = EMA(DIF,9);
  const MACD = DIF.map((v,i)=>2*(v-DEA[i]));

  /* =========================
     玩股網文字
  ========================= */
  const maText = maList.map(
    m => `MA${m} ${MAs[m].at(-1).toFixed(2)} ${arrow(MAs[m])}`
  ).join("   ");

  const volText =
    `MV5 ${MV5.at(-1).toFixed(1)} ${arrow(MV5)}   ` +
    `MV20 ${MV20.at(-1).toFixed(1)} ${arrow(MV20)}   ` +
    `量 ${V.at(-1).toLocaleString()} ${arrow(V)}`;

  const kdText =
    `K9 ${K.at(-1).toFixed(2)} ${arrow(K)}   ` +
    `D9 ${D.at(-1).toFixed(2)} ${arrow(D)}`;

  document.getElementById("title").innerText =
    `${ticker}\n${maText}\n${volText}\n${kdText}`;

  /* =========================
     K 線圖
  ========================= */
  Plotly.newPlot("kline", [
    {
      type: "candlestick",
      x: t, open: O, high: H, low: L, close: C,
      increasing: { line: { color: "red" } },
      decreasing: { line: { color: "green" } }
    },
    ...maList.map(m => ({
      x: t, y: MAs[m],
      type: "scatter",
      mode: "lines",
      name: `MA${m}`,
      line: { width: 1 }
    }))
  ], {
    paper_bgcolor:"#111",
    plot_bgcolor:"#111",
    font:{color:"#eee"},
    xaxis:{rangeslider:{visible:false}},
    title:"K 線"
  });

  /* =========================
     成交量圖
  ========================= */
  Plotly.newPlot("volume", [
    {
      x: t,
      y: V,
      type: "bar",
      marker: { color: V.map((v,i)=>C[i]>=O[i]?"red":"green") }
    }
  ], {
    paper_bgcolor:"#111",
    plot_bgcolor:"#111",
    font:{color:"#eee"},
    title:"成交量"
  });

  /* =========================
     KD 圖
  ========================= */
  Plotly.newPlot("kd", [
    { x:t, y:K, type:"scatter", name:"K" },
    { x:t, y:D, type:"scatter", name:"D" },
    { x:t, y:Array(t.length).fill(80), line:{dash:"dot"}, showlegend:false },
    { x:t, y:Array(t.length).fill(20), line:{dash:"dot"}, showlegend:false }
  ], {
    paper_bgcolor:"#111",
    plot_bgcolor:"#111",
    font:{color:"#eee"},
    yaxis:{range:[0,100]},
    title:"KD"
  });

  /* =========================
     MACD 圖
  ========================= */
  Plotly.newPlot("macd", [
    {
      x:t, y:MACD,
      type:"bar",
      marker:{ color: MACD.map(v=>v>=0?"red":"green") },
      name:"MACD"
    },
    { x:t, y:DIF, type:"scatter", name:"DIF" },
    { x:t, y:DEA, type:"scatter", name:"DEA" }
  ], {
    paper_bgcolor:"#111",
    plot_bgcolor:"#111",
    font:{color:"#eee"},
    title:"MACD"
  });

});
</script>
</body>
</html>
